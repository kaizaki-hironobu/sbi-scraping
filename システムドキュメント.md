# 株式スクリーニングシステム - ドキュメント

## システム概要

本システムは、株式の浮動株比率・信用倍率などの各種指標を自動で算出し、独自の計算式に基づいて銘柄をスクリーニングするツールです。

### 主な目的

- 外部サイト（karauri.net、irbank.net）から株式データを取得
- SBI 証券に依存しない安定したデータ収集の実現
- 売り・買いの勾配、近似値、直近比率、差などの指標を自動算出
- GUI 経由での柔軟なスクリーニング条件設定

---

## システム構成

### ファイル一覧

| ファイル名                | 用途                           | 備考                            |
| ------------------------- | ------------------------------ | ------------------------------- |
| **浮動株数取得.py**       | 浮動株数データの取得・更新     | 最初に実行                      |
| **検索.py**               | 株式データ検索とスクリーニング | 浮動株数取得後に実行            |
| scraping.py               | データスクレイピング処理の本体 | 検索.py から呼び出される        |
| float_scraping.py         | 旧版の浮動株数取得スクリプト   | Chrome 版（現在未使用）         |
| stocks.txt                | 対象銘柄コード一覧             | 改行区切り                      |
| kinds.txt                 | 各銘柄の市場区分データ         | 改行区切り（stocks.txt と対応） |
| float_data.csv            | 浮動株数データ                 | CSV 形式（ヘッダー付き）        |
| テスト.csv / テスト 0.csv | 検索結果の出力ファイル         | 検索.py で生成                  |

---

## 実行手順

### 1. 浮動株数取得（初回・定期更新時）

```
浮動株数取得.py を右クリック → Python Launcher で実行
```

**処理内容:**

- stocks.txt に記載された全銘柄について以下を取得:
  - irbank.net から発行済株式数を取得
  - irbank.net から大株主保有比率合計を取得
  - 浮動株数を算出（発行済株式数 × (1 - 大株主保有比率合計)）
- 結果を float_data.csv に保存（CSV形式、ヘッダー付き）

**所要時間:** 銘柄数により変動（全銘柄で数十分〜）
**待機時間:** 各銘柄あたり約1秒（0.5秒×2回のリクエスト）

### 2. データ検索・スクリーニング

```
検索.py を右クリック → Python Launcher で実行
```

**処理内容:**

- GUI ウィンドウが起動
- スクリーニング条件を設定
- 「取得」ボタンをクリックで実行
- 結果が CSV ファイルとして保存される

---

## 各ファイルの詳細動作

### 浮動株数取得.py

**使用技術:**

- BeautifulSoup（HTML パース）
- requests（HTTP リクエスト）
- csv（CSV ファイル出力）

**処理フロー:**

1. **発行済株式数の取得（get_issued_stocks 関数）**

   ```python
   def get_issued_stocks(ticker_code):
       # irbank.net/{銘柄コード} から企業情報ページのコード（E始まり）を取得
       # irbank.net/{企業コード} から発行済株式数を取得
       return issued_stocks
   ```

   - 銘柄ページから企業情報ページへのリンクを抽出（[浮動株数取得.py:17-28](浮動株数取得.py#L17-L28)）
   - 企業情報ページから「発行済み株式総数」を正規表現で抽出（[浮動株数取得.py:30-44](浮動株数取得.py#L30-L44)）

2. **大株主保有比率合計の取得（get_major_holder_ratio 関数）**

   ```python
   def get_major_holder_ratio(ticker_code):
       # irbank.net/{銘柄コード}/holder から大株主データを取得
       # 各株主の保有比率を合計
       return total_ratio
   ```

   - 株主ページから各株主の保有比率を抽出（[浮動株数取得.py:55-75](浮動株数取得.py#L55-L75)）
   - 上位株主の保有比率を合計してパーセント→小数に変換

3. **浮動株数の計算**

   ```python
   float_stocks = int(issued_stocks * (1 - major_holder_ratio))
   ```

   - 発行済株式数から大株主保有分を除外（[浮動株数取得.py:116](浮動株数取得.py#L116)）

4. **データ保存**
   - 取得成功した銘柄を float_data.csv に保存（[浮動株数取得.py:135-141](浮動株数取得.py#L135-L141)）
   - 形式: CSV（ヘッダー付き）
   - 列: 銘柄コード、発行済株式数、大株主保有比率合計、浮動株数

**特記事項:**

- SBI 証券へのログイン不要（完全にirbank.netに依存）
- エラーが発生した銘柄はスキップして処理継続
- 各リクエスト間に 0.5 秒の待機時間を設定（サーバー負荷軽減）
- 従来の float_data.txt ではなく float_data.csv に保存

---

### scraping.py

**使用技術:**

- BeautifulSoup（HTML パース）
- NumPy（線形回帰計算）
- requests（HTTP リクエスト）

**処理フロー:**

1. **初期化**

   - float_data.txt を読み込み、銘柄コードと浮動株数の辞書を生成

2. **データ取得関数（get_data）**

   ```python
   def get_data(ticker_data, data_length=19):
   ```

   **引数:**

   - `ticker_data`: 銘柄情報（コード、市場区分）
   - `data_length`: 分析対象の週数（デフォルト 19 週間）

3. **信用残高データの取得**

   - `https://irbank.net/{銘柄コード}/zandaka` から取得
   - 取得項目:
     - 買い残（mtb）
     - 売り残+貸付残（mts）
     - 信用売り（selling）
   - データは 10 万株単位に変換
   - 直近 19 週間分（または利用可能な最大期間）を使用

4. **比率の計算**

   ```
   買い比率 = 買い残 / 浮動株数 × 100
   売り比率 = 売り残+貸付残 / 浮動株数 × 100
   信用売り比率 = 信用売り / 浮動株数 × 100
   ```

5. **線形回帰による指標算出**

   **買い残について:**

   - **勾配（買）**: 買い残の時系列データに対する線形回帰の傾き

     - 正の値: 買い残増加傾向
     - 負の値: 買い残減少傾向

   - **近似値（買）**: 次の時点での予測値

     ```
     近似値 = 切片 + 勾配 × データ長
     ```

   - **直近比率（買）**: 最新の買い残比率

     ```
     直近比率 = 最新の買い残 / 浮動株数 × 100
     ```

   - **差（買）**: 実測値と予測値の乖離
     ```
     差 = 直近比率 - 近似値
     ```

   **売り残について:**

   - 買い残と同様の計算を売り残データに適用
   - 勾配（売）、近似値（売）、直近比率（売）、差（売）を算出

   **信用売りについて:**

   - 同様の計算を信用売りデータに適用

6. **財務指標の取得**

   - `https://irbank.net/{銘柄コード}` から取得
   - 取得項目:
     - 時価総額
     - PBR（株価純資産倍率）
     - PER（株価収益率）: 予想値/実績値
     - ROE（自己資本利益率）: 予想値/実績値
     - ROA（総資産利益率）: 予想値/実績値

7. **戻り値**
   ```python
   {
       "銘柄名": str,
       "銘柄コード": str,
       "商品区分": str,
       "勾配(買)": float,
       "勾配(売)": float,
       "近似値(買)": float,
       "近似値(売)": float,
       "直近比率(買)": float,
       "直近比率(売)": float,
       "差(買)": float,
       "差(売)": float,
       "勾配(信用売り)": float,
       "近似値(信用売り)": float,
       "差(信用売り)": float,
       "直近比率(信用売り)": float,
       "PBR": str,
       "PER(予)": str,
       "PER(赤字)": str,
       "ROE(予)": str,
       "ROE(赤字)": str,
       "ROA(予)": str,
       "ROA(赤字)": str,
       "時価総額": str
   }
   ```

**特記事項:**

- データが取得できない場合は `False` を返す
- 財務指標が取得できない場合は "-" を設定
- 警告メッセージは非表示に設定

---

### 検索.py

**使用技術:**

- tkinter（GUI）
- threading（バックグラウンド処理）
- pandas（CSV 出力）

**GUI 構成:**

#### スクリーニング条件設定エリア

**各指標のフィルタリング（8 項目）:**

1. 勾配（売）
2. 直近比率（売）
3. 近似値（売）
4. 差（売）
5. 勾配（買）
6. 直近比率（買）
7. 近似値（買）
8. 差（買）

各項目に対して:

- チェックボックス: 条件の有効/無効
- 入力ボックス: 閾値の設定
- ラジオボタン: 「以上」または「以下」

**市場区分フィルタ:**

- プライム
- グロース
- スタンダード

複数選択可能（OR 条件）

**ソート設定:**

- 並び順: 昇順 / 降順 / なし
- ソート対象:
  - 勾配（買/売）
  - 直近比率（買/売）
  - 近似値（買/売）
  - 差（買/売）

**その他:**

- 保存ファイル名: 出力 CSV のファイル名指定
- 取得ボタン: スクリーニング実行

#### 処理フロー

1. **stocks_to_list 関数**

   - stocks.txt と kinds.txt を読み込み
   - 銘柄コードと市場区分を辞書形式で返す

2. **get_calculated_data 関数（メイン処理）**

   ```python
   def get_calculated_data():
       # 1. データ取得
       # 2. フィルタリング
       # 3. ソート
       # 4. CSV出力
   ```

   **ステップ 1: データ取得**

   - 全銘柄（デフォルト 300 銘柄）に対して scraping.get_data()を実行
   - 進捗バーを表示（tqdm）

   **ステップ 2: フィルタリング**

   - 各指標に対して設定された条件をチェック
   - 条件に合致しない銘柄を除外

   フィルタリング例:

   ```python
   if var1.get():  # 勾配（売）の条件が有効な場合
       if var12.get():  # 「以下」が選択されている場合
           if data["勾配(売)"] > float(textBox1.get()):
               continue  # 条件に合わないのでスキップ
   ```

   - 市場区分でフィルタリング（プライム/グロース/スタンダード）
   - 少なくとも 1 つの市場区分が選択されている必要がある

   **ステップ 3: ソート**

   - 選択された項目で昇順または降順にソート
   - ソート対象列の値を基準に sorted()関数を使用

   **ステップ 4: CSV 出力**

   - pandas DataFrame に変換
   - 指定されたファイル名で CSV 出力
   - 出力列:
     - 銘柄コード
     - 銘柄名
     - 勾配(売)
     - 近似値(売)
     - 直近比率(売)
     - 差(売)
     - 勾配(買)
     - 近似値(買)
     - 直近比率(買)
     - 差(買)

3. **on_scraping 関数**
   - 別スレッドで get_calculated_data()を実行
   - GUI をブロックせずバックグラウンド処理

**特記事項:**

- 現在は最初の 300 銘柄のみ処理（34 行目）
  ```python
  for stock in tqdm.tqdm(all_stocks[:300]):
  ```
- 全銘柄を対象にする場合は `[:300]` を削除
- 数値は小数点第 2 位まで丸めて出力

---

### float_scraping.py（旧版）

**現在の状況:** 未使用（Chrome 版）

**浮動株数取得.py との違い:**

- Chrome WebDriver を使用（浮動株数取得.py は Firefox）
- webdriver_manager で自動的に ChromeDriver をダウンロード
- 基本的な処理フローは同じ

**使用を避ける理由:**

- SBI 証券のサイト構成変更に影響されやすい
- 現在は Firefox 版（浮動株数取得.py）が推奨される

---

## データファイル詳細

### stocks.txt

```
1301
1305
1306
...
```

- 各行に 1 つの銘柄コード
- 対象銘柄の一覧
- 東証コード形式

### kinds.txt

```
プライム（内国株式）
グロース（内国株式）
スタンダード（内国株式）
...
```

- stocks.txt と行数が一致
- 各銘柄の市場区分情報
- 括弧書きで詳細情報

### float_data.csv

```csv
銘柄コード,発行済株式数,大株主保有比率合計,浮動株数
1301,1000000000,0.4567,543300000
1305,500000000,0.3214,339300000
...
```

- 形式: CSV（ヘッダー付き）
- 浮動株数取得.py で生成
- 列: 銘柄コード、発行済株式数、大株主保有比率合計、浮動株数

---

## 計算ロジックの詳細

### 線形回帰による指標算出

本システムでは、NumPy の`polyfit`関数を使用して 1 次の線形回帰を行います。

```python
x = np.array(range(1, len(datas)+1))  # 週番号 [1, 2, 3, ..., 19]
y = np.array(mtbs)                    # 買い残データ
a, b = np.polyfit(x, y, 1)            # 1次回帰: y = ax + b
```

**計算式:**

- **勾配（a）**: トレンドの強さと方向

  - 正: 増加傾向
  - 負: 減少傾向
  - 値が大きいほど変化が急

- **近似値**: `b + a × データ長`

  - 線形トレンドに基づく次週の予測値

- **差**: `直近比率 - 近似値`
  - 正: 予測より高い（買い圧力が強い可能性）
  - 負: 予測より低い（売り圧力が強い可能性）

### 活用例

**買いシグナル検出例:**

- 勾配（買）が正で大きい → 買い残増加中
- 差（買）が正 → トレンド以上に買われている
- 勾配（売）が負 → 売り残減少中

**売りシグナル検出例:**

- 勾配（売）が正で大きい → 売り残増加中
- 差（売）が正 → トレンド以上に売られている
- 勾配（買）が負 → 買い残減少中

---

## 必要な環境・依存関係

### Python パッケージ

```
requests
beautifulsoup4
numpy
pandas
tqdm
tkinter（標準ライブラリ）
```

### インストールコマンド

```bash
pip install requests beautifulsoup4 numpy pandas tqdm
```

### 認証情報ファイル

不要（SBI証券へのログインが不要になったため）

---

## システムの移行完了状況

本システムは、**完全な脱 SBI 証券化**を達成しました。

### 移行完了した部分（irbank.net 使用）

**scraping.py** - 信用残高・財務指標の取得

- ✅ `https://irbank.net/{銘柄コード}/zandaka` から信用残高データを取得
  - 買い残（mtb）
  - 売り残+貸付残（mts）
  - 信用売り（selling）
- ✅ `https://irbank.net/{銘柄コード}` から財務指標を取得
  - 時価総額、PBR、PER、ROE、ROA

**ステータス:** 完全に irbank.net に移行済み、SBI 証券への依存なし

**浮動株数取得.py** - 浮動株数の取得

- ✅ irbank.net から発行済株式数を取得（[浮動株数取得.py:10-48](浮動株数取得.py#L10-L48)）
- ✅ irbank.net から大株主保有比率合計を取得（[浮動株数取得.py:50-82](浮動株数取得.py#L50-L82)）
- ✅ 浮動株数を計算：発行済株式数 × (1 - 大株主保有比率合計)（[浮動株数取得.py:116](浮動株数取得.py#L116)）

**ステータス:** 完全に irbank.net に移行済み、SBI 証券への依存なし

### 移行によるメリット

1. **認証不要**: SBI証券へのログインが不要
2. **保守性向上**: サイト構成変更の影響を受けにくい
3. **データ充実**: 発行済株式数、大株主比率など詳細データを保存
4. **依存削減**: Selenium/WebDriverが不要

### 浮動株数の計算方法

従来のSBI証券の「浮動株比率」とは異なるアプローチを採用：

```
浮動株数 = 発行済株式数 × (1 - 大株主保有比率合計)
```

この方法により、大株主に固定されていない流動性のある株式数を推定します。

---

## トラブルシューティング

### よくある問題と解決策

#### 1. 発行済株式数が取得できない

- irbank.net のサイト構成が変更された可能性
- 正規表現パターンを確認（[浮動株数取得.py:38](浮動株数取得.py#L38)）
- 企業情報ページへのリンク（E始まり）が見つからない場合はスキップされる

#### 2. 大株主保有比率が取得できない

- irbank.net の株主ページの構成を確認
- 正規表現パターンを確認（[浮動株数取得.py:71](浮動株数取得.py#L71)）
- データが存在しない銘柄はスキップされる

#### 3. データ取得が途中で止まる

- ネットワーク接続を確認
- アクセス先サイト（irbank.net）がメンテナンス中でないか確認
- 待機時間を増やす（サーバー側のレート制限の可能性）

#### 4. 検索.py でエラーが出る

- float_data.csv が存在するか確認
- 先に浮動株数取得.py を実行してデータを生成
- scraping.py が float_data.csv を正しく読み込んでいるか確認

#### 5. CSV ファイルが出力されない

- ファイル名入力欄に名前を入力（拡張子.csv は自動付与）
- 書き込み権限があるか確認

#### 6. 「企業情報ページへのリンクが見つかりません」エラー

- 一部の銘柄では irbank.net にデータが存在しない可能性
- 該当銘柄はスキップされ、処理は継続される

---

## システムの制約・注意事項

### データ取得の制約

1. **処理時間**

   - 全銘柄の浮動株数取得には数十分〜数時間かかる可能性
   - 検索処理も 300 銘柄で数分程度必要

2. **スクレイピング対象サイトの変更**

   - irbank.net、Yahoo!ファイナンスのサイト構成が変更されるとエラーが発生
   - その場合は CSS Selector の更新が必要

3. **アクセス制限**
   - 短時間に大量のリクエストを送るとアクセス制限を受ける可能性
   - 適切な待機時間を設定済み

### データの正確性

- 取得データは外部サイトに依存
- リアルタイムではなく、サイトの更新頻度に依存
- 信用残高データは週次更新

### 法的・倫理的配慮

- スクレイピングは各サイトの利用規約を遵守すること
- 商用利用の場合はサイト運営者の許可が必要な場合がある
- 取得データの使用は自己責任

---

## 今後の改善案

### 機能面

1. **データソースの多様化**

   - 複数のデータソースから取得して精度向上
   - API を持つサービスへの移行検討

2. **スクリーニング条件の拡充**

   - AND/OR 条件の組み合わせ
   - より複雑なフィルタリングルール

3. **可視化機能**

   - グラフ表示機能の追加
   - トレンドの視覚化

4. **自動実行**
   - 定期実行機能（cron 等）
   - 変化があった銘柄の通知機能

### 技術面

1. **エラーハンドリングの強化**

   - より詳細なエラーメッセージ
   - リトライ機能の実装

2. **パフォーマンス改善**

   - 並列処理の導入
   - キャッシュ機能の実装

3. **コードの保守性向上**

   - 設定ファイルの外部化
   - CSS Selector の管理方法改善
   - ログ機能の追加

4. **GUI 改善**
   - より直感的なインターフェース
   - 進捗状況のリアルタイム表示
   - 結果のプレビュー機能

---

## まとめ

本システムは以下の 2 ステップで動作します:

1. **浮動株数取得.py**: 全銘柄の浮動株数データを取得・更新（irbank.netから）
2. **検索.py**: 各種指標を算出し、条件に基づいてスクリーニング

**完全な脱SBI証券化を達成**し、irbank.netのみからデータを取得することで、安定した運用が可能になっています。線形回帰による指標算出とGUIによる柔軟な条件設定により、多角的な銘柄分析が実現されています。
