# 株式分析システム

## プロジェクト概要

本プロジェクトは、株式の各種指標を自動で取得・算出し、銘柄をスクリーニングするツール群です。

### 主な機能

- **銘柄分析**: PER、PSR、適正株価などを分析
- **浮動株数分析**: 信用残高データに基づく銘柄スクリーニング
- 外部サイト（karauri.net、irbank.net）からデータを取得
- SBI証券に依存しない安定したデータ収集

---

## プロジェクト構成

```
sbiスクレイピング/
├── 銘柄分析/
│   └── 銘柄分析_GUI.py          # PER/PSR分析ツール（GUI版）
│
├── 浮動株数分析/
│   ├── 浮動株数取得.py          # 浮動株数データ取得
│   ├── scraping.py             # 信用残高データ取得
│   ├── 検索.py                 # スクリーニングツール（GUI版）
│   ├── stocks.txt              # 銘柄コード一覧
│   ├── kinds.txt               # 銘柄区分データ
│   └── float_data.csv          # 浮動株数データ（自動生成）
│
├── venv312/                    # Python仮想環境
└── README.md                   # このファイル
```

---

## 1. 銘柄分析ツール

### 概要

PER（株価収益率）、PSR（株価売上高倍率）から適正株価を算出し、現在株価との乖離率を表示します。

### 実行方法

```bash
cd 銘柄分析
source ../venv312/bin/activate
python3 銘柄分析_GUI.py
```

### 使い方

1. GUIウィンドウが起動
2. 銘柄コード（4桁）を入力
3. 「分析」ボタンをクリック
4. 結果が表示される
5. 複数銘柄を分析後、CSVファイル名を入力して「CSV保存」

### 取得データ

| 項目 | 説明 |
|------|------|
| 銘柄コード | 4桁の証券コード |
| 銘柄名 | 会社名 |
| 市場区分 | プライム/スタンダード/グロース |
| PER | 株価収益率（赤字の場合は「赤字」表示） |
| PSR | 株価売上高倍率 |
| ZPER | PERのZスコア（赤字の場合はペナルティ定数） |
| ZPSR | PSRのZスコア |
| 適正株価 | PER/PSRから計算した理論株価 |
| 現在株価 | 直近1週間の終値最高値 |
| 変化率 | 適正株価に対する現在株価の乖離率 |

### 計算ロジック

#### Zスコア化

```
ZPER = (PER - 25) / 10
ZPSR = (PSR - 1.0) / 1.0
```

赤字企業の場合、市場区分別のペナルティ定数を適用：
- グロース: -0.8
- スタンダード: -1.2
- プライム: -2.0

#### 適正株価の計算

```
PER係数 = 25 / PER（黒字の場合）
PSR係数 = 1.0 / PSR
総合係数 = √(PER係数 × PSR係数)
適正株価 = 現在株価 × 総合係数
```

#### 変化率

```
変化率 = (現在株価 - 適正株価) / 適正株価 × 100
```

- 正の値: 現在株価が適正株価より割高
- 負の値: 現在株価が適正株価より割安

### データソース

- **irbank.net**: 時価総額、PER、売上高、発行済株式数
- **karauri.net**: 市場区分

---

## 2. 浮動株数分析ツール

### 概要

信用残高データ（買い残、売り残）の時系列分析により、銘柄のトレンドを検出します。

### 実行手順

#### Step 1: 浮動株数データの取得（初回・定期更新時）

```bash
cd 浮動株数分析
source ../venv312/bin/activate
python3 浮動株数取得.py
```

**処理内容:**
- stocks.txtに記載された全銘柄について以下を取得:
  - 発行済株式数（irbank.netから）
  - 大株主保有比率合計（irbank.netから）
  - 浮動株数 = 発行済株式数 × (1 - 大株主保有比率合計)
- 結果をfloat_data.csvに保存

**所要時間:** 銘柄数により変動（全銘柄で数十分〜）

#### Step 2: 銘柄スクリーニング

```bash
cd 浮動株数分析
source ../venv312/bin/activate
python3 検索.py
```

**処理内容:**
- GUIウィンドウが起動
- スクリーニング条件を設定
- 「取得」ボタンで実行
- 結果がCSVファイルとして保存

### 取得指標

#### 信用残高指標（買い・売り）

| 指標 | 説明 |
|------|------|
| 勾配 | 線形回帰の傾き（トレンドの強さ） |
| 近似値 | 次週の予測値 |
| 直近比率 | 最新の信用残高 / 浮動株数 × 100 |
| 差 | 実測値と予測値の乖離 |

#### 計算方法

```python
# 線形回帰（NumPy使用）
x = [1, 2, 3, ..., 26]  # 週番号（半年分）
y = [買い残データ]
a, b = np.polyfit(x, y, 1)  # y = ax + b

勾配 = a
近似値 = b + a × データ長
差 = 直近比率 - 近似値
```

### スクリーニング条件設定

- **8つの指標フィルタ**: 勾配・近似値・直近比率・差（買い・売り）
- **市場区分フィルタ**: プライム/スタンダード/グロース
- **ソート機能**: 各指標で昇順/降順/なし

### データソース

- **irbank.net/{銘柄コード}/zandaka**: 信用残高データ
- **irbank.net/{銘柄コード}**: 財務指標（PBR、PER、ROE、ROA）

### 活用例

**買いシグナル検出:**
- 勾配（買）が正で大きい → 買い残増加中
- 差（買）が正 → トレンド以上に買われている
- 勾配（売）が負 → 売り残減少中

**売りシグナル検出:**
- 勾配（売）が正で大きい → 売り残増加中
- 差（売）が正 → トレンド以上に売られている
- 勾配（買）が負 → 買い残減少中

---

## 環境構築

### 必要なPythonパッケージ

```
requests
beautifulsoup4
numpy
pandas
tqdm
tkinter（標準ライブラリ）
```

### インストール

```bash
# 仮想環境の有効化
source venv312/bin/activate

# パッケージインストール
pip install requests beautifulsoup4 numpy pandas tqdm
```

---

## データファイル詳細

### stocks.txt

```
1301
1305
1306
...
```

- 各行に1つの銘柄コード
- 東証コード形式

### kinds.txt

```
プライム（内国株式）
グロース（内国株式）
スタンダード（内国株式）
...
```

- stocks.txtと行数が一致
- 各銘柄の市場区分情報

### float_data.csv

```csv
銘柄コード,発行済株式数,大株主保有比率合計,浮動株数
1301,12052000,0.3503,7830184
...
```

- 浮動株数取得.pyで生成
- 信用残高の比率計算に使用

---

## システムの特徴

### 完全な脱SBI証券化

- ✅ **認証不要**: SBI証券へのログインが不要
- ✅ **保守性向上**: サイト構成変更の影響を受けにくい
- ✅ **依存削減**: Selenium/WebDriverが不要
- ✅ **データ充実**: 発行済株式数、大株主比率など詳細データを保存

### データ取得の安定性

- 適切な待機時間設定（各リクエスト間0.5秒）
- エラー発生時は該当銘柄をスキップして処理継続
- User-Agentヘッダーを設定してアクセス

---

## トラブルシューティング

### 銘柄分析

**PSRが「取得失敗」と表示される**
- 売上高データが存在しない銘柄（研究開発型企業など）
- irbank.netに売上データがない場合

**変化率が算出不可**
- PERまたはPSRが取得できない場合

### 浮動株数分析

**float_data.csvが見つからない**
- 先に浮動株数取得.pyを実行してデータを生成

**データ取得が途中で止まる**
- ネットワーク接続を確認
- irbank.netがメンテナンス中でないか確認
- 待機時間を増やす（サーバー側のレート制限の可能性）

**企業情報ページへのリンクが見つかりません**
- 一部の銘柄ではirbank.netにデータが存在しない
- 該当銘柄はスキップされ、処理は継続

---

## 制約・注意事項

### データ取得の制約

1. **処理時間**
   - 全銘柄の浮動株数取得には数十分〜数時間かかる可能性
   - 検索処理も300銘柄で数分程度必要

2. **スクレイピング対象サイトの変更**
   - irbank.net、karauri.netのサイト構成が変更されるとエラーが発生
   - その場合はコードの更新が必要

3. **アクセス制限**
   - 短時間に大量のリクエストを送るとアクセス制限を受ける可能性
   - 適切な待機時間を設定済み

### データの正確性

- 取得データは外部サイトに依存
- リアルタイムではなく、サイトの更新頻度に依存
- 信用残高データは週次更新

### 法的・倫理的配慮

- スクレイピングは各サイトの利用規約を遵守すること
- 商用利用の場合はサイト運営者の許可が必要な場合がある
- 取得データの使用は自己責任

---

## 今後の改善案

### 機能面

- データソースの多様化（複数ソースから取得して精度向上）
- スクリーニング条件の拡充（AND/OR条件の組み合わせ）
- 可視化機能（グラフ表示、トレンドの視覚化）
- 自動実行機能（定期実行、変化通知）

### 技術面

- エラーハンドリングの強化（リトライ機能）
- パフォーマンス改善（並列処理、キャッシュ）
- コードの保守性向上（設定ファイル外部化、ログ機能）
- GUI改善（進捗表示、結果プレビュー）

---

## まとめ

本システムは以下の2つのツールで構成されています:

1. **銘柄分析**: PER/PSRから適正株価を算出し、割安・割高を判定
2. **浮動株数分析**: 信用残高の時系列分析により、トレンドを検出

**完全な脱SBI証券化**を達成し、irbank.netとkarauri.netのみからデータを取得することで、安定した運用が可能になっています。
